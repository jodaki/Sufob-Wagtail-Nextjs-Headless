# راهنمای راه‌اندازی ماژول Scroll Time

## مقدمه
ماژول Scroll Time برای دریافت خودکار داده‌های قیمت از سرور سازمان بورس و کالا طراحی شده است. این ماژول امکانات زیر را فراهم می‌کند:

- مدیریت دسته‌بندی‌ها (گروه اصلی، گروه، زیرگروه)
- ارسال درخواست به API سازمان بورس
- پیش‌نمایش داده‌های دریافت شده
- مدیریت داده‌های تکراری
- ذخیره خودکار یا دستی داده‌ها
- گزارش‌گیری کامل از عملیات

## مراحل نصب و راه‌اندازی

### 1. اجرای Migration ها

```bash
cd backend
python manage.py makemigrations prices
python manage.py migrate
```

### 2. پرکردن داده‌های اولیه

```bash
python manage.py populate_categories
```

یا از طریق migration:
```bash
python manage.py migrate prices 0004
```

### 3. بررسی تنظیمات

اطمینان حاصل کنید که اپلیکیشن `prices` در `INSTALLED_APPS` موجود است:

```python
# settings/base.py یا settings.py
INSTALLED_APPS = [
    # ... سایر اپلیکیشن‌ها
    'prices',
    # ...
]
```

### 4. بروزرسانی URLconf

در فایل `sufob/urls.py` مسیر اپلیکیشن prices را اضافه کنید:

```python
from django.urls import path, include

urlpatterns = [
    # ... سایر مسیرها
    path('prices/', include('prices.urls')),
    # ...
]
```

## نحوه استفاده

### 1. دسترسی به پنل Scroll Time

پس از ورود به پنل مدیریت Wagtail:

1. به بخش "Scroll Time" بروید
2. روی "Scroll Time جدید" کلیک کنید

### 2. ایجاد درخواست جدید

1. **انتخاب دسته‌بندی**: گروه اصلی، گروه و زیرگروه را انتخاب کنید
2. **تعیین بازه زمانی**: تاریخ شروع و پایان را به فرمت شمسی وارد کنید (مثل: 1404/5/11)
3. **تنظیمات پردازش**: نحوه مواجهه با داده‌های تکراری را انتخاب کنید
4. **ذخیره خودکار**: فعال کنید اگر می‌خواهید داده‌ها بلافاصله ذخیره شوند

### 3. ارسال درخواست

1. پس از ایجاد درخواست، به صفحه ارسال هدایت می‌شوید
2. روی "ارسال درخواست" کلیک کنید
3. منتظر دریافت داده‌ها بمانید

### 4. پیش‌نمایش و تأیید

1. داده‌های دریافت شده را بررسی کنید
2. نمونه رکوردها را مشاهده کنید
3. در صورت تأیید، روی "تأیید و ذخیره داده‌ها" کلیک کنید

## ساختار فایل‌ها

```
backend/prices/
├── migrations/
│   ├── 0003_add_scroll_time_models.py
│   └── 0004_populate_initial_categories.py
├── management/
│   └── commands/
│       └── populate_categories.py
├── templates/
│   └── wagtailadmin/
│       └── scroll_time/
│           ├── create.html
│           ├── send.html
│           ├── preview.html
│           └── completed.html
├── models.py (بروزرسانی شده)
├── forms.py (بروزرسانی شده)
├── services.py (جدید)
├── scroll_time_views.py (جدید)
├── urls.py (بروزرسانی شده)
└── wagtail_hooks.py (بروزرسانی شده)
```

## API Endpoint

درخواست‌ها به آدرس زیر ارسال می‌شوند:
```
https://www.ime.co.ir/subsystems/ime/services/home/imedata.asmx/GetAmareMoamelatList
```

## نمونه Payload ارسالی

```json
{
    "Language": 8,
    "fari": false,
    "GregorianFromDate": "1404/5/11",
    "GregorianToDate": "1404/5/14",
    "MainCat": 1,
    "Cat": 49,
    "SubCat": 477,
    "Producer": 0
}
```

## مدیریت داده‌های تکراری

سه روش برای مواجهه با داده‌های تکراری وجود دارد:

1. **رد کردن رکوردهای تکراری**: داده‌های تکراری نادیده گرفته می‌شوند
2. **جایگزینی رکوردهای تکراری**: رکورد قدیمی حذف و رکورد جدید جایگزین می‌شود
3. **بروزرسانی رکوردهای موجود**: فقط فیلدهای تغییر یافته بروزرسانی می‌شوند

## مشکلات رایج و راه‌حل

### 1. خطای ارتباط با سرور بورس
- بررسی کنید که سرور به اینترنت دسترسی دارد
- ممکن است سرور بورس موقتاً در دسترس نباشد

### 2. خطای فرمت تاریخ
- از فرمت صحیح شمسی استفاده کنید: `1404/5/11`
- اطمینان حاصل کنید که تاریخ پایان بعد از تاریخ شروع است

### 3. عدم نمایش دسته‌بندی‌ها
- اطمینان حاصل کنید که migration ها اجرا شده‌اند
- command `populate_categories` را اجرا کنید

## بهینه‌سازی و نکات مهم

1. **استفاده از Cache**: برای بهبود عملکرد، نتایج API را cache کنید
2. **Rate Limiting**: برای جلوگیری از spam، محدودیت زمانی روی درخواست‌ها اعمال کنید
3. **Async Processing**: برای درخواست‌های بزرگ، از Celery استفاده کنید
4. **Logging**: تمام عملیات را log کنید تا قابلیت debug داشته باشید

## گسترش و توسعه

برای اضافه کردن دسته‌بندی‌های جدید:

1. به پنل مدیریت Wagtail بروید
2. بخش "دسته‌بندی‌ها" را انتخاب کنید
3. گروه‌های اصلی، گروه‌ها یا زیرگروه‌های جدید اضافه کنید

## تست و بررسی

برای تست صحت عملکرد:

1. یک درخواست نمونه ایجاد کنید
2. دسته‌بندی سنگ آهن -> کنسانتره را انتخاب کنید
3. بازه زمانی کوتاهی (مثل 3 روز) انتخاب کنید
4. درخواست را ارسال کرده و نتیجه را بررسی کنید

## پشتیبانی و توسعه بیشتر

این ماژول قابلیت گسترش دارد و می‌توان موارد زیر را به آن اضافه کرد:

- پشتیبانی از سایر API های بورس
- ایجاد گزارش‌های تحلیلی
- ارسال اعلان‌ها بعد از دریافت داده
- پردازش خودکار بر اساس زمان‌بندی (Cron Jobs)
- امکان export داده‌ها به فرمت‌های مختلف
