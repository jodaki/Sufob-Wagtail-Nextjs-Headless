{% extends "admin/base_site.html" %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<style>
/* رفع تداخل با jazzmin */
.jalali_date-input, .persian-datepicker {
    z-index: 9999 !important;
    background: #fff !important;
    color: #222 !important;
    font-family: inherit !important;
}
.persian-datepicker-container {
    z-index: 99999 !important;
}
</style>
{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Import/Export</h2>
            <form id="import-export-form" class="row g-3">
                <div class="col-md-6">
                    <label for="product_type" class="form-label">نوع محصول:</label>
                    <select id="product_type" name="product_type" class="form-select" required>
                        <option value="iron_concentrate">کنسانتره آهن</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">رفتار با رکوردهای تکراری:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="duplicate_action" id="remove_duplicates" value="remove" checked>
                        <label class="form-check-label" for="remove_duplicates">اطلاعات تکراری حذف شود</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="duplicate_action" id="replace_duplicates" value="replace">
                        <label class="form-check-label" for="replace_duplicates">اطلاعات تکراری جایگزین شود</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="from_date" class="form-label">تاریخ شروع (شمسی):</label>
<input type="text" id="from_date" name="from_date" class="form-control jalali_date-input" autocomplete="off" required readonly>
                </div>
                <div class="col-md-6">
                    <label for="to_date" class="form-label">تاریخ پایان (شمسی):</label>
<input type="text" id="to_date" name="to_date" class="form-control jalali_date-input" autocomplete="off" required readonly>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">بارگذاری اطلاعات</button>
                </div>
            </form>
<div id="loading" class="mt-3" style="display:none;">در حال بارگذاری... <span class="loader"></span></div>
<div id="result" class="mt-3"></div>
<div id="sample-record" class="mt-3"></div>
<div class="mt-5" id="sample-table-section" style="display:none;">
    <h5>نمونه جدول معاملات (نمایش تستی):</h5>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="sample-table" style="font-family: IRANSans, Tahoma, sans-serif;">
            <thead class="table-dark">
                <tr>
                    <th>نام کالا</th>
                    <th>نماد</th>
                    <th>تالار</th>
                    <th>تولید کننده</th>
                    <th>نوع قرارداد</th>
                    <th>قیمت پایانی میانگین موزون</th>
                    <th>ارزش معامله (هزارریال)</th>
                    <th>پایین ترین</th>
                    <th>بالاترین</th>
                    <th>قیمت پایه عرضه</th>
                    <th>حجم عرضه</th>
                    <th>تقاضا</th>
                    <th>حجم قرارداد</th>
                    <th>واحد</th>
                    <th>تاریخ معامله</th>
                    <th>عرضه کننده</th>
                    <th>کارگزار</th>
                    <th>نوع تسویه</th>
                </tr>
            </thead>
            <tbody id="sample-table-body">
            </tbody>
        </table>
    </div>
</div>
            <div id="db-actions" class="mt-4" style="display:none;">
                <button id="btn-insert-db" class="btn btn-success">افزودن به دیتابیس</button>
            </div>
<button id="show-action-log" class="btn btn-outline-danger mb-3" style="display:block;">نمایش اطلاعات اضافی</button>
<div id="action-log" class="mt-3" style="display:none; background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; border-radius:8px; padding:16px;"></div>
        </div>
    </div>
</div>
<style>
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script>
$(document).ready(function() {
    // فقط یکبار تقویم را روی هر input فعال کن
    $('.jalali_date-input').each(function(){
        $(this).persianDatepicker({
            format: 'YYYY/MM/DD',
            initialValue: false,
            autoClose: true,
            toolbox: { calendarSwitch: { enabled: false } },
            observer: true,
            altField: this,
            altFormat: 'YYYY/MM/DD',
            onShow: function(){
                $('.persian-datepicker-container').css('z-index', '99999');
            }
        });
    });
    $('#show-action-log').on('click', function(){
        $('#action-log').toggle();
    });
    window.actionLog = function(msg) {
        $('#action-log').append('<div>' + msg + '</div>');
    };
});

let extractedData = [];

$('#import-export-form').on('submit', function(e) {
    e.preventDefault();
    $('#result').empty();
    $('#sample-record').empty();
    $('#sample-table-section').hide();
    $('#loading').show();
    $('#db-actions').hide();
    $('#action-log').hide().empty();
    actionLog('درخواست بارگذاری اطلاعات ارسال شد...');
    $.ajax({
        url: window.location.pathname + 'api/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            from_date: $('#from_date').val(),
            to_date: $('#to_date').val()
        }),
        success: function(data) {
            $('#loading').hide();
            if(data.success) {
                let sample = data.sample || (data.records && data.records[0]) || (data.data && data.data[0]) || null;
                let count = data.count || (data.records && data.records.length) || (data.data && data.data.length) || 0;
                extractedData = (data.records || data.data || data.items || data.result || []);
                $('#result').html('<b>تعداد رکورد دانلود شد: </b>' + count);
                actionLog('اطلاعات با موفقیت دریافت شد. تعداد رکورد: ' + count);
                if(sample) actionLog('نمونه رکورد: <pre>' + JSON.stringify(sample, null, 2) + '</pre>');
                if(data.log_msgs && data.log_msgs.length > 0) {
                    data.log_msgs.forEach(function(msg){ actionLog(msg); });
                }
                actionLog('تعداد رکورد ذخیره شده در StagedTransaction: ' + (data.staged_saved || 0));
                if(data.staged_errors && data.staged_errors.length > 0) {
                    actionLog('<span class="text-danger">خطاهای ذخیره:</span><ul>' + data.staged_errors.map(function(err){return '<li>'+err+'</li>';}).join('') + '</ul>');
                }
                $('#db-actions').show();
            } else {
                $('#result').html('<span style="color:red">خطا: ' + data.error + '</span>');
                if(data.log_msgs && data.log_msgs.length > 0) {
                    data.log_msgs.forEach(function(msg){ actionLog(msg); });
                }
            }
        },
        error: function(xhr) {
            $('#loading').hide();
            let msg = 'خطای ارتباط با سرور';
            if(xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
            $('#result').html('<span style="color:red">' + msg + '</span>');
            actionLog('خطا در بارگذاری اطلاعات: ' + msg);
        }
    });
});

$('#btn-insert-db').on('click', function() {
    $('#result').append('<div class="mt-3">در حال ثبت نهایی در دیتابیس... <span class="loader"></span></div>');
    actionLog('درخواست ثبت نهایی در دیتابیس ارسال شد...');
    $.ajax({
        url: window.location.pathname + 'confirm/',
        method: 'POST',
        success: function(data) {
            $('.loader').remove();
            let msg = '<div class="mt-3 text-success">';
            msg += 'ثبت نهایی انجام شد.<br>';
            msg += 'تعداد رکوردهای موفق: <b>' + (data.success || 0) + '</b><br>';
            msg += 'تعداد رکوردهای تکراری: <b>' + (data.duplicate || 0) + '</b><br>';
            msg += 'تعداد رکوردهای خطادار: <b>' + (data.error || 0) + '</b>';
            if(data.error_list && data.error_list.length > 0) {
                msg += '<br><span class="text-danger">خطاها:</span><ul>';
                data.error_list.forEach(function(err) {
                    msg += '<li>' + err + '</li>';
                });
                msg += '</ul>';
            }
            msg += '</div>';
            $('#result').append(msg);
            actionLog('ثبت نهایی انجام شد. موفق: ' + (data.success || 0) + ', تکراری: ' + (data.duplicate || 0) + ', خطادار: ' + (data.error || 0));
            if(data.error_list && data.error_list.length > 0) {
                actionLog('<span class="text-danger">خطاها:</span><ul>' + data.error_list.map(function(err){return '<li>'+err+'</li>';}).join('') + '</ul>');
            }
            // بررسی ذخیره شدن در StagedTransaction
            $.ajax({
                url: window.location.pathname + 'check-staged/',
                method: 'GET',
                success: function(resp) {
                    if(resp.count !== undefined) {
                        actionLog('تعداد رکوردهای باقی‌مانده در StagedTransaction: ' + resp.count);
                        if(resp.count === 0) {
                            actionLog('<span class="text-success">همه رکوردها از StagedTransaction منتقل شدند.</span>');
                        } else {
                            actionLog('<span class="text-danger">برخی رکوردها هنوز در StagedTransaction باقی مانده‌اند!</span>');
                        }
                    }
                },
                error: function() {
                    actionLog('<span class="text-danger">خطا در بررسی StagedTransaction!</span>');
                }
            });
            // بررسی ذخیره شدن در Transaction
            $.ajax({
                url: window.location.pathname + 'check-transaction/',
                method: 'GET',
                success: function(resp) {
                    if(resp.count !== undefined) {
                        actionLog('تعداد رکوردهای موجود در Transaction: ' + resp.count);
                    }
                },
                error: function() {
                    actionLog('<span class="text-danger">خطا در بررسی Transaction!</span>');
                }
            });
        },
        error: function(xhr) {
            $('.loader').remove();
            let msg = 'خطای ارتباط با سرور';
            if(xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
            $('#result').append('<div class="mt-3 text-danger">' + msg + '</div>');
            actionLog('خطا در ثبت نهایی: ' + msg);
        }
    });
});
</script>
</script>
{% endblock %}
